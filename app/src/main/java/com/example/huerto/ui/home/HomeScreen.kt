package com.example.huerto.ui.homeimport kotlinx.coroutines.launchimport android.app.Applicationimport androidx.compose.foundation.layout.*import androidx.compose.foundation.lazy.LazyColumnimport androidx.compose.foundation.lazy.itemsimport androidx.compose.material.icons.Iconsimport androidx.compose.material.icons.filled.Homeimport androidx.compose.material.icons.filled.LocalFireDepartmentimport androidx.compose.material.icons.filled.Mapimport androidx.compose.material.icons.filled.ShoppingCartimport androidx.compose.material3.*import androidx.compose.runtime.*import androidx.compose.ui.Alignmentimport androidx.compose.ui.Modifierimport androidx.compose.ui.platform.LocalContextimport androidx.compose.ui.unit.dpimport androidx.lifecycle.ViewModelimport androidx.lifecycle.ViewModelProviderimport androidx.lifecycle.viewmodel.compose.viewModelimport androidx.navigation.NavHostControllerimport androidx.navigation.compose.NavHostimport androidx.navigation.compose.composableimport androidx.navigation.compose.currentBackStackEntryAsStateimport androidx.navigation.compose.rememberNavControllerimport com.example.huerto.data.local.UserPrefsimport com.example.huerto.data.repository.SessionRepositoryimport com.example.huerto.ui.nosotros.NosotrosMapScreenimport com.example.huerto.ui.product.ProductosTabprivate object HomeTabs {    const val INICIO = "tab_inicio"    const val PRODUCTOS = "tab_productos"    const val CARRITO = "tab_carrito"    const val NOSOTROS = "tab_nosotros"}@Composablefun HomeScreen(onLoggedOut: () -> Unit) {    val app = LocalContext.current.applicationContext as Application    val vm: HomeViewModel = viewModel(factory = HomeVMFactory(app))    val nav = rememberNavController()    Scaffold(        bottomBar = { HomeBottomBar(nav) }    ) { padding ->        NavHost(            navController = nav,            startDestination = HomeTabs.INICIO,            modifier = Modifier                .fillMaxSize()                .padding(padding)        ) {            composable(HomeTabs.INICIO) {                InicioTab(                    onGoProductos = {                        nav.navigate(HomeTabs.PRODUCTOS) {                            launchSingleTop = true                            restoreState = true                            popUpTo(nav.graph.startDestinationId) { saveState = true }                        }                    },                    onLogout = {                        vm.logout()                        onLoggedOut()                    }                )            }            composable(HomeTabs.PRODUCTOS) {                ProductosTab(                    onGoCart = {                        nav.navigate(HomeTabs.CARRITO) {                            launchSingleTop = true                            restoreState = true                            popUpTo(nav.graph.startDestinationId) { saveState = true }                        }                    }                )            }            composable(HomeTabs.CARRITO) {                CartScreen()            }            composable(HomeTabs.NOSOTROS) {                NosotrosMapScreen()            }        }    }}@Composableprivate fun HomeBottomBar(nav: NavHostController) {    val app = LocalContext.current.applicationContext as Application    val cartVm: CartViewModel = viewModel(factory = CartViewModel.provideFactory(app))    val cart by cartVm.ui.collectAsState()    data class Item(        val route: String,        val label: String,        val icon: androidx.compose.ui.graphics.vector.ImageVector,        val showBadge: Boolean = false    )    val items = listOf(        Item(HomeTabs.INICIO, "Inicio", Icons.Filled.Home),        Item(HomeTabs.PRODUCTOS, "Productos", Icons.Filled.LocalFireDepartment),        Item(HomeTabs.CARRITO, "Carrito", Icons.Filled.ShoppingCart, showBadge = true),        Item(HomeTabs.NOSOTROS, "Nosotros", Icons.Filled.Map)    )    NavigationBar {        val backStack by nav.currentBackStackEntryAsState()        val current = backStack?.destination?.route        items.forEach { it ->            NavigationBarItem(                selected = current == it.route,                onClick = {                    nav.navigate(it.route) {                        launchSingleTop = true                        restoreState = true                        popUpTo(nav.graph.startDestinationId) { saveState = true }                    }                },                icon = {                    if (it.showBadge && cart.count > 0) {                        BadgedBox(badge = { Badge { Text(cart.count.toString()) } }) {                            Icon(it.icon, contentDescription = it.label)                        }                    } else {                        Icon(it.icon, contentDescription = it.label)                    }                },                label = { Text(it.label) }            )        }    }}@Composableprivate fun InicioTab(    onGoProductos: () -> Unit,    onLogout: () -> Unit) {    Surface(Modifier.fillMaxSize()) {        Box(Modifier.fillMaxSize(), contentAlignment = Alignment.Center) {            Column(                horizontalAlignment = Alignment.CenterHorizontally,                verticalArrangement = Arrangement.spacedBy(12.dp)            ) {                Text("ðŸ¡ Bienvenido a tu Huerto Digital", style = MaterialTheme.typography.headlineSmall)                Text("Desde aquÃ­ puedes ir al catÃ¡logo de productos.", style = MaterialTheme.typography.bodyMedium)                Row(horizontalArrangement = Arrangement.spacedBy(12.dp)) {                    Button(onClick = onGoProductos) { Text("Ver productos") }                    OutlinedButton(onClick = onLogout) { Text("Cerrar sesiÃ³n") }                }            }        }    }}/* --------- CARRITO --------- */@Composableprivate fun CartScreen() {    val app = LocalContext.current.applicationContext as Application    val vm: CartViewModel = viewModel(factory = CartViewModel.provideFactory(app))    val ui by vm.ui.collectAsState()    Surface(Modifier.fillMaxSize()) {        Column(            Modifier.fillMaxSize().padding(16.dp),            verticalArrangement = Arrangement.spacedBy(12.dp)        ) {            Text("ðŸ§º Carrito", style = MaterialTheme.typography.titleLarge)            if (ui.items.isEmpty()) {                Text("Tu carrito estÃ¡ vacÃ­o.")            } else {                LazyColumn(                    modifier = Modifier.weight(1f),                    verticalArrangement = Arrangement.spacedBy(8.dp)                ) {                    items(ui.items, key = { it.id }) { line ->                        ListItem(                            headlineContent = { Text(line.name) },                            supportingContent = { Text("Precio $${line.price} Â· Subtotal $${line.subtotal}") },                            trailingContent = {                                Row(verticalAlignment = Alignment.CenterVertically) {                                    OutlinedButton(onClick = { vm.dec(line.productId, line.quantity) }) { Text("âˆ’") }                                    Spacer(Modifier.width(8.dp))                                    Text("${line.quantity}", style = MaterialTheme.typography.titleMedium)                                    Spacer(Modifier.width(8.dp))                                    Button(onClick = { vm.inc(line.productId, line.quantity) }) { Text("+") }                                }                            }                        )                        Divider()                    }                }                Text("TOTAL: $${ui.total}", style = MaterialTheme.typography.headlineSmall)                Row(horizontalArrangement = Arrangement.spacedBy(12.dp)) {                    OutlinedButton(onClick = { vm.clear() }, modifier = Modifier.weight(1f)) { Text("Vaciar") }                    Button(onClick = { /* TODO: acciÃ³n de pago */ }, modifier = Modifier.weight(1f)) { Text("Pagar") }                }            }        }    }}private class HomeViewModel(private val repo: SessionRepository) : ViewModel() {    fun logout() = kotlinx.coroutines.GlobalScope.launch { repo.logout() }}private class HomeVMFactory(private val app: Application) : ViewModelProvider.Factory {    override fun <T : ViewModel> create(modelClass: Class<T>): T {        val repo = SessionRepository(UserPrefs(app))        return HomeViewModel(repo) as T    }}